# 前端部署完整说明

## 项目结构

```
frontend/
├── admin-ui/          # 管理后台（端口 5170）
│   ├── src/
│   ├── dist/         # 打包后的文件（需要部署这个）
│   └── vite.config.js
└── user-ui/           # 用户端（端口 5171）
    ├── src/
    ├── dist/         # 打包后的文件（需要部署这个）
    └── vite.config.js
```

---

## 一、本地开发环境

### 启动方式

#### 方法1：分别启动
```powershell
# 启动管理后台
cd c:\test\cxsj\now\frontend\admin-ui
npm run dev
# 访问: http://localhost:5170

# 启动用户端
cd c:\test\cxsj\now\frontend\user-ui
npm run dev
# 访问: http://localhost:5171
```

#### 方法2：使用启动脚本
```powershell
# 在 c:\test\cxsj\now 目录下
.\start-frontend.bat
```

### 开发环境配置说明

**admin-ui/vite.config.js**:
- 端口: 5170
- API 代理: `/api` → `http://localhost:8080`
- 自动打开浏览器

**user-ui/vite.config.js**:
- 端口: 5171
- API 代理: `/api` → `http://localhost:8080`
- 自动打开浏览器

---

## 二、生产环境打包

### 1. 安装依赖（首次）
```powershell
# 管理后台
cd c:\test\cxsj\now\frontend\admin-ui
npm install

# 用户端
cd c:\test\cxsj\now\frontend\user-ui
npm install
```

### 2. 打包项目
```powershell
# 打包管理后台
cd c:\test\cxsj\now\frontend\admin-ui
npm run build
# 生成 admin-ui/dist/ 文件夹

# 打包用户端
cd c:\test\cxsj\now\frontend\user-ui
npm run build
# 生成 user-ui/dist/ 文件夹
```

### 3. 验证打包结果
```powershell
# 预览管理后台
cd c:\test\cxsj\now\frontend\admin-ui
npm run preview

# 预览用户端
cd c:\test\cxsj\now\frontend\user-ui
npm run preview
```

---

## 三、服务器部署方案

### 方案A: Nginx 部署（推荐）

#### 1. 上传文件到服务器
```bash
# 将打包后的文件上传到服务器
admin-ui/dist/ → /var/www/activity-admin/
user-ui/dist/  → /var/www/activity-user/
```

#### 2. Nginx 配置示例

**管理后台配置** (`/etc/nginx/sites-available/activity-admin`):
```nginx
server {
    listen 80;
    server_name admin.yourdomain.com;  # 改为你的域名
    
    root /var/www/activity-admin;
    index index.html;
    
    # 开启 gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 代理后端 API
    location /api/ {
        proxy_pass http://localhost:8080/;  # 后端地址
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**用户端配置** (`/etc/nginx/sites-available/activity-user`):
```nginx
server {
    listen 80;
    server_name user.yourdomain.com;  # 改为你的域名
    
    root /var/www/activity-user;
    index index.html;
    
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 3. 启用配置并重启 Nginx
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/activity-admin /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/activity-user /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 4. 配置 HTTPS（推荐使用 Let's Encrypt）
```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx

# 为管理后台申请证书
sudo certbot --nginx -d admin.yourdomain.com

# 为用户端申请证书
sudo certbot --nginx -d user.yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

---

### 方案B: 宝塔面板部署（更简单）

#### 1. 安装宝塔面板
```bash
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

#### 2. 创建网站
1. 登录宝塔面板
2. 网站 → 添加站点
   - 管理后台: `admin.yourdomain.com`
   - 用户端: `user.yourdomain.com`
3. 选择 PHP 版本（纯静态选择"纯静态"）

#### 3. 上传文件
1. 删除网站目录下的默认文件
2. 上传 `dist` 文件夹内的所有文件到网站根目录

#### 4. 配置反向代理
1. 进入网站设置 → 反向代理
2. 添加代理:
   - 代理名称: `api`
   - 目标URL: `http://127.0.0.1:8080`
   - 发送域名: `$host`
   - 代理目录: `/api/`

#### 5. 配置伪静态（支持 SPA 路由）
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

#### 6. 申请 SSL 证书
网站设置 → SSL → Let's Encrypt → 申请

---

### 方案C: Docker 部署

#### 1. 创建 Dockerfile（管理后台）

**admin-ui/Dockerfile**:
```dockerfile
FROM nginx:alpine

# 复制打包文件
COPY dist/ /usr/share/nginx/html/

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**admin-ui/nginx.conf**:
```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 2. 创建 docker-compose.yml
```yaml
version: '3'
services:
  admin:
    build: ./admin-ui
    ports:
      - "8081:80"
    depends_on:
      - backend
  
  user:
    build: ./user-ui
    ports:
      - "8082:80"
    depends_on:
      - backend
  
  backend:
    image: openjdk:17
    ports:
      - "8080:8080"
    volumes:
      - ./backend.jar:/app.jar
    command: java -jar /app.jar
```

#### 3. 构建并运行
```bash
docker-compose up -d
```

---

## 四、重要配置说明

### 1. API 地址配置

#### 开发环境（自动代理）
- 前端请求: `/api/xxx`
- Vite 代理到: `http://localhost:8080/xxx`
- **无需修改代码**

#### 生产环境（三种情况）

**情况1: 前后端同域名（推荐）**
```
前端: https://yourdomain.com
后端: https://yourdomain.com/api
```
✅ 无需修改前端代码，Nginx 反向代理即可

**情况2: 后端独立域名**
修改 `src/api/client.js`:
```javascript
const apiClient = axios.create({
  baseURL: 'https://api.yourdomain.com',  // 改为后端地址
  timeout: 10000,
});
```
⚠️ 需要后端配置 CORS

**情况3: 使用环境变量（推荐）**

创建 `.env.production`:
```env
VITE_API_BASE_URL=https://api.yourdomain.com
```

修改 `src/api/client.js`:
```javascript
const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 10000,
});
```

### 2. 后端 CORS 配置（如果前后端分离域名）

**后端需添加 CORS 配置**:
```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins(
                    "https://admin.yourdomain.com",
                    "https://user.yourdomain.com"
                )
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

### 3. 路由模式说明

前端使用 **BrowserRouter**（History 模式），需要服务器配置支持：

**Nginx 配置**:
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

**宝塔伪静态**:
```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

---

## 五、部署流程总结

### 快速部署步骤（Nginx）

```bash
# 1. 本地打包
cd frontend/admin-ui && npm run build
cd ../user-ui && npm run build

# 2. 上传到服务器
scp -r admin-ui/dist/* user@server:/var/www/activity-admin/
scp -r user-ui/dist/* user@server:/var/www/activity-user/

# 3. 配置 Nginx（参考上面的配置）
sudo vim /etc/nginx/sites-available/activity-admin
sudo vim /etc/nginx/sites-available/activity-user

# 4. 启用并重启
sudo ln -s /etc/nginx/sites-available/activity-admin /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/activity-user /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 5. 配置 SSL（可选）
sudo certbot --nginx -d admin.yourdomain.com
sudo certbot --nginx -d user.yourdomain.com
```

---

## 六、常见问题排查

### 1. 页面空白
- 检查浏览器控制台错误
- 检查网络请求是否正常
- 检查 Nginx 配置是否正确

### 2. 刷新页面 404
- 检查 Nginx 是否配置了 `try_files $uri $uri/ /index.html;`
- 检查宝塔伪静态是否配置

### 3. API 请求失败
- 检查后端服务是否运行
- 检查 Nginx 反向代理配置
- 检查后端 CORS 配置
- 使用浏览器开发者工具查看网络请求

### 4. 静态资源加载失败
- 检查 `vite.config.js` 中的 `base` 配置
- 检查服务器路径是否正确
- 检查文件权限

### 5. 登录后跳转失败
- 检查 Token 存储（localStorage）
- 检查路由配置
- 检查后端 Session/Token 配置

---

## 七、性能优化建议

### 1. 开启 Gzip 压缩
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
gzip_min_length 1000;
```

### 2. 配置静态资源缓存
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 使用 CDN
- 将静态资源上传到 CDN
- 修改打包配置指向 CDN 地址

### 4. 代码分割（已配置）
Vite 自动进行代码分割，无需额外配置

---

## 八、安全建议

1. **启用 HTTPS**（必须）
2. **配置防火墙**，只开放必要端口
3. **设置 Nginx 安全头**:
```nginx
add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
```
4. **定期更新依赖**
5. **配置访问日志和错误日志**

---

## 九、监控和维护

### 1. Nginx 日志
```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

### 2. 更新部署
```bash
# 1. 本地重新打包
npm run build

# 2. 备份旧版本
mv /var/www/activity-admin /var/www/activity-admin.bak

# 3. 上传新版本
scp -r dist/* user@server:/var/www/activity-admin/

# 4. 清除浏览器缓存或使用版本号
```

### 3. 自动化部署脚本
```bash
#!/bin/bash
# deploy.sh

# 打包
cd frontend/admin-ui && npm run build
cd ../user-ui && npm run build

# 上传
scp -r admin-ui/dist/* user@server:/var/www/activity-admin/
scp -r user-ui/dist/* user@server:/var/www/activity-user/

# 重启 Nginx
ssh user@server "sudo systemctl reload nginx"

echo "部署完成！"
```

---

## 十、检查清单

部署前检查:
- [ ] 代码已打包（`npm run build` 成功）
- [ ] API 地址配置正确
- [ ] 后端服务已启动
- [ ] 服务器环境准备好（Nginx/宝塔）
- [ ] 域名 DNS 解析配置
- [ ] 防火墙端口开放（80, 443）

部署后验证:
- [ ] 网站可以正常访问
- [ ] 页面刷新不出现 404
- [ ] API 请求正常
- [ ] 登录功能正常
- [ ] 文件上传功能正常
- [ ] 图片显示正常
- [ ] 移动端兼容性正常

---

## 联系方式

如遇问题，请检查:
1. 浏览器控制台错误信息
2. Nginx 错误日志
3. 后端服务日志
4. 网络请求详情（开发者工具 Network 面板）

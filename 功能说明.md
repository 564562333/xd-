# 前端功能说明文档

## 一、项目概述

本项目包含两个独立的前端应用：
- **管理后台 (admin-ui)** - 供管理员使用，管理活动、查看报名、生成海报等
- **用户端 (user-ui)** - 供普通用户使用，报名活动、签到、查看报名记录等

---

## 二、管理后台 (admin-ui)

### 访问地址
- 开发环境: `http://localhost:5170`
- 生产环境: 根据部署配置

### 页面结构

```
管理后台
├── 登录页面 (/login)
├── 主布局 (/)
    ├── 活动管理 (/activity)
    ├── 新建活动 (/activity/new)
    ├── 编辑活动 (/activity/edit/:id)
    └── 海报管理 (/poster)
```

---

### 1. 登录页面 (`/login`)

**文件**: `src/pages/Login.jsx`

#### 功能说明
- 管理员账号密码登录
- 记住登录状态（Token 存储到 localStorage）
- 登录成功后跳转到活动管理页面

#### 界面元素
- 用户名输入框
- 密码输入框（带密码显示/隐藏）
- 登录按钮

#### 技术实现
- 使用 Ant Design Form 组件
- 调用 `/admin/login` 接口
- Token 存储机制：localStorage
- 路由守卫：未登录自动跳转到登录页

---

### 2. 活动管理页面 (`/activity`)

**文件**: `src/pages/ActivityList.jsx`

#### 功能说明
活动列表的增删改查、搜索过滤、二维码生成、海报查看

#### 主要功能模块

##### 2.1 搜索过滤区域
- **活动名称搜索** - 模糊搜索
- **活动状态筛选** - 下拉选择
  - 未发布
  - 未开始报名
  - 报名中
  - 未开始
  - 进行中
  - 已结束
- **是否已满筛选** - 已满/未满
- **活动地点搜索** - 模糊搜索
- **搜索/重置按钮** - 执行搜索或清空条件

##### 2.2 新建活动按钮
- 点击跳转到新建活动页面

##### 2.3 活动列表表格
显示列：
- **活动名称**
- **活动简介**
- **报名时间** - 报名开始时间 ~ 报名结束时间
- **活动时间** - 活动开始时间 ~ 活动结束时间
- **活动地点**
- **报名情况** - 当前报名人数/名额上限
- **活动状态** - 带颜色标签显示
  - 未发布（金色）
  - 未开始报名（浅绿色）
  - 报名中（绿色）
  - 未开始（青色）
  - 进行中（蓝色）
  - 已结束（灰色）
- **操作列**

##### 2.4 操作列功能按钮

**编辑按钮**
- 跳转到编辑页面
- 可修改活动信息

**删除按钮**
- 二次确认弹窗
- 删除活动及相关数据
- 自动删除 OSS 上的二维码图片

**报名码按钮** 🆕
- 点击后调用后端接口生成报名二维码
- 弹窗显示二维码图片（300x300）
- 二维码内容：报名页面 URL
- 支持图片预览和下载

**签到码按钮** 🆕
- 点击后调用后端接口生成签到二维码
- 弹窗显示二维码图片（300x300）
- 二维码内容：签到页面 URL
- 支持图片预览和下载

**查看海报按钮** 🆕
- 点击后查询该活动的所有历史海报
- 弹窗以网格形式展示所有海报
- 每个海报卡片包含：
  - 海报图片预览
  - 下载按钮
- 空状态提示："暂无海报"

##### 2.5 分页功能
- 每页显示数量可调整
- 页码切换
- 总数显示

#### 接口调用
- `GET /activity` - 查询活动列表（支持分页和过滤）
- `DELETE /activity/{id}` - 删除活动
- `GET /registration/{id}/registration/qrcode` - 生成报名二维码
- `GET /registration/{id}/checkin/qrcode` - 生成签到二维码
- `GET /poster?id={activityId}` - 查询活动海报列表

---

### 3. 新建活动页面 (`/activity/new`)

**文件**: `src/pages/ActivityForm.jsx`

#### 功能说明
创建新的活动，填写活动详细信息

#### 表单字段

##### 基本信息
- **活动名称** *(必填)*
  - 文本输入
  - 不能为空
  
- **活动简介** *(可选)*
  - 多行文本输入
  - 最多 200 字

- **活动地点** *(必填)*
  - 文本输入
  - 活动举办地点

##### 时间设置
- **报名开始时间** *(必填)*
  - 日期时间选择器
  - 格式：YYYY-MM-DD HH:mm
  
- **报名结束时间** *(必填)*
  - 日期时间选择器
  - 必须晚于报名开始时间
  
- **活动开始时间** *(必填)*
  - 日期时间选择器
  - 建议晚于报名结束时间
  
- **活动结束时间** *(必填)*
  - 日期时间选择器
  - 必须晚于活动开始时间

##### 报名限制
- **报名人数上限** *(必填)*
  - 数字输入
  - 最小值：1
  - 默认值：100

- **签到距离限制（米）** *(必填)*
  - 数字输入
  - 最小值：0
  - 默认值：100
  - 用于签到时的地理位置验证

##### 活动状态
- **活动状态** *(必填)*
  - 下拉选择
  - 选项：
    - 1 - 未发布
    - 2 - 未开始报名
    - 3 - 报名中
    - 4 - 未开始
    - 5 - 进行中
    - 6 - 已结束

#### 表单操作
- **提交按钮** - 创建活动
- **返回按钮** - 返回活动列表

#### 表单验证
- 必填字段验证
- 时间逻辑验证
- 数字范围验证
- 提交前完整性检查

#### 接口调用
- `POST /activity` - 创建活动

---

### 4. 编辑活动页面 (`/activity/edit/:id`)

**文件**: `src/pages/ActivityForm.jsx`（复用新建页面）

#### 功能说明
编辑已存在的活动信息

#### 特点
- 复用新建活动页面组件
- 根据 URL 参数 `id` 判断是编辑模式
- 页面加载时自动获取活动详情并填充表单
- 表单字段与新建活动相同

#### 接口调用
- `GET /activity/{id}` - 获取活动详情
- `PUT /activity/{id}` - 更新活动信息

---

### 5. 海报管理页面 (`/poster`)

**文件**: `src/pages/PosterManage.jsx`

#### 功能说明
为活动生成宣传海报，合成模板图片和二维码

#### 主要功能模块

##### 5.1 海报生成表单
- **选择活动** *(必填)*
  - 下拉选择框
  - 自动加载所有活动列表
  - 显示：活动名称
  - 选择后自动查询该活动的历史海报

- **海报类型** *(必填)* 🆕
  - 单选框
  - 选项：
    - 报名海报 - 使用报名二维码
    - 签到海报 - 使用签到二维码
  - 不同类型生成不同的二维码

- **选择模板** *(必填)*
  - 下拉选择框
  - 自动加载 OSS 中的所有海报模板
  - 显示模板图片的 URL

- **合成海报按钮**
  - 点击后执行海报合成流程

##### 5.2 海报合成流程

**第一步：获取二维码**
- 根据选择的海报类型调用对应接口：
  - 报名海报 → 调用报名二维码接口
  - 签到海报 → 调用签到二维码接口
- 二维码尺寸：300x300
- 返回二维码图片 URL

**第二步：调用后端合成**
- 将模板 URL 和二维码 URL 发送给后端
- 后端使用 FFmpeg 进行图片合成
- 合成参数：
  - 二维码缩放：250x250
  - 二维码位置：overlay=125:175（模板左上角偏移）
- 最多重试 3 次（每次间隔 2 秒）
- 处理超时时间：60 秒

**第三步：前端回退方案**
- 如果后端合成失败或超时
- 自动使用前端 Canvas 合成
- 前端合成流程：
  1. 加载模板图片
  2. 加载二维码图片
  3. 使用 Canvas 绘制
  4. 导出为 PNG 并下载
- 需要处理 CORS 跨域问题

##### 5.3 海报展示区域

**当前生成的海报**
- 显示刚刚生成的海报
- 图片预览
- 下载按钮

**历史海报展示**
- 网格布局（响应式）
- 每个活动的所有历史海报
- 每个海报卡片包含：
  - 海报预览图
  - 下载按钮
  - 图片点击放大预览
- 空状态提示

##### 5.4 辅助功能

**URL 处理**
- 自动去除 OSS URL 中的查询参数（签名等）
- 使用正则表达式：`stripQuery(url)`
- 目的：后端根据纯净路径判断图片类型

**错误处理**
- 网络请求失败提示
- 图片加载失败提示
- Canvas 合成失败提示
- CORS 跨域问题提示

#### 接口调用
- `GET /activity` - 获取活动列表
- `GET /poster/templates` - 获取所有模板列表
- `GET /registration/{id}/registration/qrcode` - 获取报名二维码
- `GET /registration/{id}/checkin/qrcode` - 获取签到二维码
- `GET /poster/combine` - 合成海报（带重试机制）
- `GET /poster?id={activityId}` - 查询活动海报列表

#### 技术特点
- 后端优先，前端回退
- 自动重试机制
- Canvas 图片处理
- CORS 跨域处理
- 文件下载功能

---

### 6. 主布局 (`MainLayout`)

**文件**: `src/components/MainLayout.jsx`

#### 功能说明
管理后台的整体布局框架

#### 布局结构
- **顶部导航栏**
  - Logo / 系统名称
  - 管理员信息
  - 退出登录按钮

- **侧边菜单**
  - 活动管理（带图标）
  - 海报管理（带图标）
  - 菜单项高亮显示当前页面

- **内容区域**
  - 路由内容渲染
  - 面包屑导航
  - 页面内容

#### 功能
- 响应式布局
- 菜单折叠/展开
- 路由导航
- 登录状态检查
- 退出登录功能

---

## 三、用户端 (user-ui)

### 访问地址
- 开发环境: `http://localhost:5171`
- 生产环境: 根据部署配置

### 页面结构

```
用户端
├── 活动报名页面 (/registration/:activityId)
├── 签到页面 (/checkin/:activityId)
├── 我的报名页面 (/my-registrations)
└── 报名记录查询页面 (/result)
```

---

### 1. 活动报名页面 (`/registration/:activityId`)

**文件**: `src/pages/Registration.jsx`

#### 功能说明
用户扫描报名二维码或直接访问链接 `/registration/{活动ID}` 后进入该活动的报名页，填写报名信息参加活动。`activityId` 通过路由参数获取。

#### 页面流程

**第一步：选择活动**
- 显示所有可报名的活动列表
- 活动卡片展示：
  - 活动名称（大标题）
  - 活动简介
  - 活动时间
  - 活动地点
  - 报名人数/名额上限
  - 活动状态标签
- 点击"报名"按钮进入报名表单

**第二步：填写报名信息**
弹出报名表单，包含以下字段：

- **姓名** *(必填)*
  - 文本输入
  - 真实姓名
  
- **手机号** *(必填)*
  - 文本输入
  - 格式验证：11 位数字
  - 正则验证：`/^1[3-9]\d{9}$/`
  
- **邮箱** *(可选)*
  - 文本输入
  - 邮箱格式验证
  
- **备注** *(可选)*
  - 多行文本输入
  - 最多 200 字

**第三步：提交报名**
- 点击"提交报名"按钮
- 表单验证
- 调用报名接口
- 成功提示并关闭弹窗
- 失败显示错误信息（如已报名、名额已满等）

#### 活动状态说明
只显示以下状态的活动：
- 报名中（状态 3）
- 未开始（状态 4）
- 进行中（状态 5）

#### 接口调用
- `GET /activity` - 获取活动列表
- `POST /registration` - 提交报名

#### 错误处理
- 重复报名提示
- 名额已满提示
- 手机号格式错误提示
- 网络请求失败提示

---

### 2. 签到页面 (`/checkin/:activityId`)

**文件**: `src/pages/Checkin.jsx`

#### 功能说明
用户扫描签到二维码或直接访问链接 `/checkin/{活动ID}` 后进入，输入报名手机号进行签到，`activityId` 由路由参数提供。

#### 页面元素
- **手机号输入框** *(必填)*
  - 11 位手机号
  - 格式验证
  
- **签到按钮**
  - 点击后执行签到

#### 签到流程

**第一步：输入手机号**
- 用户输入已报名的手机号

**第二步：获取地理位置**
- 自动调用浏览器地理定位 API
- 获取用户当前经纬度
- 如果获取失败，提示用户授权位置权限

**第三步：验证距离**
- 将用户位置发送给后端
- 后端计算用户位置与活动地点的距离
- 判断是否在签到范围内（根据活动设置的距离限制）

**第四步：执行签到**
- 距离验证通过
- 更新签到状态
- 记录签到时间和位置
- 显示签到成功提示

#### 地理定位说明
使用浏览器原生 API：
```javascript
navigator.geolocation.getCurrentPosition()
```

获取的信息：
- 纬度（latitude）
- 经度（longitude）
- 精度（accuracy）

#### 接口调用
- `POST /registration/checkin` - 提交签到信息

#### 错误处理
- 手机号格式错误
- 未报名该活动
- 已经签到过
- 不在签到时间内
- 距离超出范围
- 地理位置获取失败
- 网络请求失败

---

### 3. 我的报名页面 (`/my-registrations`)

**文件**: `src/pages/MyRegistrations.jsx`

#### 功能说明
用户通过输入手机号查询自己关联的活动报名列表，并可点“查看详情”跳转到对应的报名页 `/registration/{活动ID}`。

#### 主要元素
- 手机号查询表单（格式校验 + 提交）
- 活动报名记录表格（分页）
  - 活动名称 / 状态 / 地点 / 活动时间 / 报名时间
  - 操作列：跳转到该活动报名详情（重新查看或补报名信息）
- 顶部提示区域：三种报名方式说明（二维码、分享链接、直接访问 URL）

#### 接口调用
- `GET /registration?phone={phone}` 查询该手机号所有报名记录（分页）

#### 功能特点
- 支持分页回显
- 状态彩色标签显示
- 与二维码跳转路径一致（无歧义）

### 4. 报名记录页面 (`/result`)

**文件**: `src/pages/Result.jsx`

#### 功能说明
用户查看自己的报名记录和签到状态

#### 页面元素

**手机号查询**
- 手机号输入框
- 查询按钮
- 格式验证

**报名记录列表**
显示该手机号的所有报名记录，每条记录包含：
- **活动名称**
- **活动简介**
- **活动时间**
- **活动地点**
- **报名时间**
- **签到状态** - 标签显示
  - 已签到（绿色）
  - 未签到（灰色）
- **签到时间** - 如果已签到

#### 数据展示
- 卡片列表形式
- 支持分页
- 按报名时间倒序排列
- 空状态提示："暂无报名记录"

#### 接口调用
- `GET /registration?phone={phone}` - 查询报名记录（支持分页）

#### 功能特点
- 手机号验证
- 分页加载
- 签到状态实时显示
- 时间格式化显示

---

## 四、公共功能模块

### 1. API 请求封装

**文件**: `src/api/client.js`

#### 功能说明
统一的 HTTP 请求客户端

#### 配置
- 基础 URL: `/api`（开发环境通过 Vite 代理到后端）
- 超时时间: 10 秒
- 自动携带 Token（从 localStorage 读取）

#### 拦截器

**请求拦截器**
- 自动添加 Token 到请求头
- 请求日志记录

**响应拦截器**
- 统一错误处理
- Token 过期自动跳转登录
- 错误消息提示
- 响应数据解包

#### 错误处理
- 401: Token 过期，跳转登录
- 403: 无权限
- 404: 接口不存在
- 500: 服务器错误
- 网络错误: 超时、断网等

---

### 2. API 接口模块

#### 管理后台接口 (`src/api/`)

**admin.js** - 管理员相关
- `login(data)` - 管理员登录

**activity.js** - 活动管理相关
- `getActivityList(params)` - 获取活动列表
- `createActivity(data)` - 创建活动
- `getActivityById(id)` - 获取活动详情
- `updateActivity(id, data)` - 更新活动
- `deleteActivity(id)` - 删除活动
- `getRegistrationQRCode(id, params)` - 获取报名二维码 🆕
- `getCheckinQRCode(id, params)` - 获取签到二维码 🆕
- `getAllTemplates()` - 获取所有海报模板
- `combinePoster(params)` - 合成海报
- `getActivityPosters(id)` - 获取活动海报列表 🆕

#### 用户端接口 (`src/api/`)

**user.js** - 用户相关
- `getActivities(params)` - 获取活动列表
- `register(data)` - 报名活动
- `checkin(data)` - 签到
- `getRegistrations(phone, params)` - 查询报名记录

---

### 3. 路由配置

#### 管理后台路由
```javascript
{
  path: '/login',
  component: Login
},
{
  path: '/',
  component: MainLayout,
  children: [
    {
      path: 'activity',
      component: ActivityList
    },
    {
      path: 'activity/new',
      component: ActivityForm
    },
    {
      path: 'activity/edit/:id',
      component: ActivityForm
    },
    {
      path: 'poster',
      component: PosterManage
    }
  ]
}
```

#### 用户端路由（当前实现）
```javascript
{
  path: '/registration/:activityId',
  component: Registration
},
{
  path: '/checkin/:activityId',
  component: Checkin
},
{
  path: '/my-registrations',
  component: MyRegistrations
},
{
  path: '/result',
  component: Result
}
```

#### 直接访问与二维码规范
- 报名二维码指向：`/registration/{活动ID}`
- 签到二维码指向：`/checkin/{活动ID}`
- 用户可直接在浏览器输入上述路径快速进入对应活动的报名或签到页面。

---

### 4. 工具函数

#### 日期格式化
```javascript
dayjs(date).format('YYYY-MM-DD HH:mm:ss')
```

#### 手机号验证
```javascript
/^1[3-9]\d{9}$/.test(phone)
```

#### Token 管理
```javascript
localStorage.getItem('token')
localStorage.setItem('token', token)
localStorage.removeItem('token')
```

#### URL 查询参数处理
```javascript
stripQuery(url) // 去除 URL 中的 ? 及之后的参数
```

---

## 五、技术栈说明

### 核心框架
- **React 18.2** - UI 框架
- **React Router 6** - 路由管理
- **Vite 5** - 构建工具

### UI 组件库
- **Ant Design 5.16+** - 企业级 UI 组件
  - Table - 数据表格
  - Form - 表单
  - Modal - 弹窗
  - Button - 按钮
  - Input - 输入框
  - Select - 下拉选择
  - DatePicker - 日期选择
  - Upload - 文件上传
  - Image - 图片展示和预览
  - Tag - 标签
  - Card - 卡片
  - Space - 间距
  - Popconfirm - 气泡确认

### 网络请求
- **Axios 1.7** - HTTP 客户端
  - 请求/响应拦截器
  - 自动携带 Token
  - 统一错误处理

### 工具库
- **dayjs 1.11** - 日期处理
- **md5 2.3** - 密码加密

### 开发工具
- **ESLint** - 代码检查
- **Vite Proxy** - 开发环境 API 代理

---

## 六、数据流说明

### 管理后台数据流

```
用户操作 → 页面组件 → API 调用 → 后端接口 → 数据库
                ↓                      ↓
            State 更新 ← 响应数据 ← 后端响应
                ↓
            页面重新渲染
```

### 用户端数据流

```
扫描二维码 → 进入页面 → 选择活动/填写信息
                           ↓
                       API 调用
                           ↓
                   后端验证/处理
                           ↓
                   返回结果/提示用户
```

---

## 七、状态管理

### 管理后台
- **登录状态**: localStorage + Token
- **活动列表**: useState + useEffect
- **表单数据**: Ant Design Form
- **模态框状态**: useState

### 用户端
- **活动列表**: useState + useEffect
- **报名表单**: Ant Design Form
- **地理位置**: 浏览器 API

---

## 八、权限控制

### 管理后台
- **路由守卫**: 检查 Token 是否存在
- **未登录**: 自动跳转到登录页
- **Token 过期**: 清除 Token 并跳转登录

### 用户端
- 无需登录
- 直接访问
- 通过二维码扫描进入

---

## 九、响应式设计

### 管理后台
- PC 端优先
- 支持平板横屏
- 侧边栏可折叠
- 表格可横向滚动

### 用户端
- 移动端优先
- 响应式布局
- 触摸友好
- 表单优化（大按钮、大输入框）

---

## 十、性能优化

### 代码层面
- 路由懒加载
- 组件按需导入
- Vite 代码分割
- 图片懒加载

### 网络层面
- API 请求防抖
- 列表分页加载
- 图片 OSS 压缩
- 缓存策略

---

## 十一、安全措施

### 前端安全
- XSS 防护（React 默认转义）
- CSRF Token（后端配合）
- 密码 MD5 加密
- Token 过期处理

### 数据验证
- 表单前端验证
- 后端二次验证
- 手机号格式验证
- 邮箱格式验证

---

## 十二、浏览器兼容性

### 支持的浏览器
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+
- 移动端浏览器（iOS Safari, Chrome Mobile）

### 不支持
- IE 11 及以下

---

## 十三、关键业务流程

### 活动发布流程
```
创建活动 → 填写信息 → 提交保存 → 生成二维码 → 生成海报 → 发布宣传
```

### 用户报名流程
```
扫描二维码 → 选择活动 → 填写信息 → 提交报名 → 等待审核 → 收到通知
```

### 用户签到流程
```
扫描签到码 → 输入手机号 → 获取位置 → 验证距离 → 完成签到 → 签到成功
```

### 海报生成流程
```
选择活动 → 选择类型 → 选择模板 → 生成二维码 → 合成海报 → 保存/下载
```

---

## 十四、后续扩展建议

### 功能扩展
- [ ] 活动报名审核功能
- [ ] 报名信息导出（Excel）
- [ ] 活动统计报表
- [ ] 消息通知功能
- [ ] 活动评价功能
- [ ] 多级管理员权限

### 体验优化
- [ ] 骨架屏加载
- [ ] 图片压缩上传
- [ ] 离线缓存
- [ ] PWA 支持
- [ ] 暗黑模式

### 技术优化
- [ ] TypeScript 重构
- [ ] 单元测试
- [ ] E2E 测试
- [ ] 性能监控
- [ ] 错误追踪（Sentry）

---

## 附录：页面截图位置建议

为了更好地理解功能，建议添加以下页面截图：
1. 登录页面
2. 活动列表页（包含搜索和操作）
3. 新建/编辑活动表单
4. 海报管理页（包含合成表单和展示）
5. 用户报名页
6. 用户签到页
7. 报名记录页
